---
title: "Exploratory Data Analysis"
output:
  html_document:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

```{r load-packages}
library(tidyverse)
library(plotly)
library(knitr)
library(maps)
```

```{r load-data}
bmw_clean <- read_csv("data/bmw_clean.csv", show_col_types = FALSE)
bmw_yearly <- read_csv("data/bmw_yearly_clean.csv", show_col_types = FALSE)
```

## Overview

This analysis explores BMW's global sales data from 2010-2024. The dataset contains 50,000 records representing different vehicle configurations (model, color, fuel type, transmission, etc.) sold across six regions. Each record shows the sales volume for a specific configuration in a given year and region.

---

## 1. Data Summary

```{r data-summary}
cat("Dataset dimensions:", nrow(bmw_clean), "rows ×", ncol(bmw_clean), "columns\n\n")

cat("Time period:", min(bmw_clean$year), "-", max(bmw_clean$year), "\n")
cat("Number of regions:", n_distinct(bmw_clean$region), "\n")
cat("Number of models:", n_distinct(bmw_clean$model), "\n")
cat("Number of unique configurations:", nrow(bmw_clean), "\n\n")

cat("Sales volume statistics:\n")
summary(bmw_clean$sales_volume)

cat("\nPrice statistics (USD):\n")
summary(bmw_clean$price_usd)
```

The dataset shows BMW offers extensive product variety with 50,000 different configuration combinations across 11 models and 6 regions over 15 years.

```{r region-summary}
region_summary <- bmw_clean %>%
  group_by(region) %>%
  summarise(
    total_volume = sum(sales_volume),
    avg_sales_per_config = mean(sales_volume),
    num_configs = n(),
    avg_price = mean(price_usd)
  ) %>%
  arrange(desc(total_volume))

knitr::kable(region_summary,
             col.names = c("Region", "Total Volume", "Avg Sales/Config", "Num Configs", "Avg Price"),
             digits = 0,
             caption = "Regional Sales Summary (2010-2024)")
```

**Key observations:**

- Regional distribution is balanced: Europe (42.6M units), Asia (43.0M), North America (42.4M)
- Average sales per configuration range from 5,036 to 5,106 across regions
- Pricing is consistent globally, averaging $75,000 across all markets
- Each region has approximately 8,300 different configurations available

---

## 2. Product Portfolio Analysis

```{r model-distribution}
model_stats <- bmw_clean %>%
  group_by(model) %>%
  summarise(
    total_volume = sum(sales_volume),
    avg_sales_per_config = mean(sales_volume),
    num_configs = n(),
    avg_price = mean(price_usd)
  ) %>%
  arrange(desc(total_volume))

knitr::kable(model_stats,
             col.names = c("Model", "Total Volume", "Avg Sales/Config", "Num Configs", "Avg Price"),
             digits = 0,
             caption = "Sales by Model")
```

```{r model-viz}
p <- ggplot(model_stats, aes(x = reorder(model, total_volume), y = total_volume/1e6)) +
  geom_col(fill = "#1C69D4") +
  coord_flip() +
  labs(title = "Total Sales Volume by Model (2010-2024)",
       x = NULL,
       y = "Total Sales (Millions)") +
  theme_minimal(base_size = 12)

ggplotly(p)
```

BMW's product portfolio shows balanced performance across all models. Total sales range from 22.3M (M3) to 23.8M (7 Series), a difference of only 6.7%. When examining average sales per configuration, all models perform similarly (5,009 - 5,122 units), with less than 2.3% variation between highest and lowest performers. This indicates no single model dominates the market.

---

## 3. Time Trends

```{r yearly-trend}
yearly_trend <- bmw_yearly %>%
  group_by(year) %>%
  summarise(total_sales = sum(total_sales),
            avg_price = mean(avg_price))

p1 <- ggplot(yearly_trend, aes(x = year, y = total_sales/1e6)) +
  geom_line(color = "#1C69D4", size = 1.2) +
  geom_point(color = "#0F4C81", size = 3) +
  labs(title = "Global Sales Trend (2010-2024)",
       x = "Year",
       y = "Total Sales (Millions)") +
  theme_minimal(base_size = 12)

ggplotly(p1)
```

Sales show remarkable stability over the 15-year period, fluctuating between 16.3M and 17.9M units annually. The 2020 dip to 16.3M units was modest (down 5% from 2019), followed by quick recovery in 2021-2022. This stability suggests a mature, established market presence.

```{r regional-trends}
p2 <- bmw_yearly %>%
  ggplot(aes(x = year, y = total_sales/1e6, color = region, group = region)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Sales Trends by Region",
       x = "Year",
       y = "Total Sales (Millions)",
       color = "Region") +
  theme_minimal(base_size = 12) +
  scale_color_brewer(palette = "Set2")

ggplotly(p2)
```

Regional trends mirror the global pattern - all regions maintain stable sales between 2.4M and 3.1M units per year. No region shows sustained growth or decline, indicating BMW has achieved equilibrium across all major markets.

```{r growth-analysis}
growth_summary <- bmw_yearly %>%
  group_by(region) %>%
  summarise(
    avg_growth = mean(sales_growth_pct, na.rm = TRUE),
    sd_growth = sd(sales_growth_pct, na.rm = TRUE),
    min_growth = min(sales_growth_pct, na.rm = TRUE),
    max_growth = max(sales_growth_pct, na.rm = TRUE)
  ) %>%
  arrange(desc(avg_growth))

knitr::kable(growth_summary,
             col.names = c("Region", "Avg Growth %", "Std Dev", "Min %", "Max %"),
             digits = 1,
             caption = "Year-over-Year Growth Statistics by Region")
```

Average annual growth rates are near zero for all regions (-0.3% to +0.1%), with volatility (std dev) around 7-8%. This confirms market maturity rather than expansion phase.

---

## 4. Geographic Distribution

```{r interactive-world-map}
world_map <- map_data("world")

# Create mapping based on geographic location
assign_region <- function(country) {
  asia_countries <- c("China", "Japan", "South Korea", "North Korea", "Mongolia", "India", "Pakistan",
                     "Bangladesh", "Sri Lanka", "Nepal", "Bhutan", "Myanmar", "Thailand", "Vietnam",
                     "Laos", "Cambodia", "Malaysia", "Singapore", "Indonesia", "Philippines",
                     "Taiwan", "Hong Kong", "Macau", "Brunei", "Timor-Leste", "Kazakhstan",
                     "Kyrgyzstan", "Tajikistan", "Turkmenistan", "Uzbekistan", "Afghanistan")

  europe_countries <- c("UK", "Ireland", "France", "Spain", "Portugal", "Italy", "Germany", "Netherlands",
                       "Belgium", "Luxembourg", "Switzerland", "Austria", "Poland", "Czech Republic",
                       "Slovakia", "Hungary", "Romania", "Bulgaria", "Greece", "Albania", "Croatia",
                       "Slovenia", "Bosnia and Herzegovina", "Serbia", "Montenegro", "North Macedonia",
                       "Denmark", "Sweden", "Norway", "Finland", "Estonia", "Latvia", "Lithuania",
                       "Iceland", "Belarus", "Ukraine", "Moldova", "Malta", "Cyprus", "Andorra",
                       "Monaco", "Liechtenstein", "San Marino", "Vatican", "Kosovo", "Russia")

  north_america_countries <- c("USA", "Canada", "Mexico", "Greenland", "Bermuda")

  south_america_countries <- c("Brazil", "Argentina", "Chile", "Peru", "Colombia", "Venezuela", "Ecuador",
                              "Bolivia", "Paraguay", "Uruguay", "Guyana", "Suriname", "French Guiana",
                              "Falkland Islands")

  africa_countries <- c("Egypt", "Libya", "Tunisia", "Algeria", "Morocco", "Western Sahara", "Mauritania",
                       "Mali", "Niger", "Chad", "Sudan", "South Sudan", "Ethiopia", "Eritrea", "Djibouti",
                       "Somalia", "Kenya", "Uganda", "Tanzania", "Rwanda", "Burundi", "Democratic Republic of the Congo",
                       "Republic of Congo", "Gabon", "Cameroon", "Nigeria", "Benin", "Togo", "Ghana",
                       "Ivory Coast", "Burkina Faso", "Senegal", "Guinea", "Sierra Leone", "Liberia",
                       "Central African Republic", "Equatorial Guinea", "Sao Tome and Principe", "Angola",
                       "Zambia", "Malawi", "Mozambique", "Zimbabwe", "Botswana", "Namibia", "South Africa",
                       "Lesotho", "Swaziland", "Madagascar", "Mauritius", "Comoros", "Seychelles",
                       "Gambia", "Guinea-Bissau", "Cape Verde")

  middle_east_countries <- c("Saudi Arabia", "Yemen", "Oman", "United Arab Emirates", "Qatar", "Bahrain",
                            "Kuwait", "Iraq", "Iran", "Syria", "Lebanon", "Israel", "Palestine", "Jordan",
                            "Turkey", "Armenia", "Azerbaijan", "Georgia")

  if (country %in% asia_countries) return("Asia")
  if (country %in% europe_countries) return("Europe")
  if (country %in% north_america_countries) return("North America")
  if (country %in% south_america_countries) return("South America")
  if (country %in% africa_countries) return("Africa")
  if (country %in% middle_east_countries) return("Middle East")
  return(NA)
}

# Get sales data for 2024
sales_2024 <- bmw_yearly %>%
  filter(year == 2024) %>%
  select(region, total_sales, avg_price)

# Apply region mapping and join sales data
world_map_colored <- world_map %>%
  mutate(bmw_region = sapply(region, assign_region)) %>%
  left_join(sales_2024, by = c("bmw_region" = "region"))

p_map <- ggplot(world_map_colored, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = total_sales/1e6,
                   text = paste("Region:", bmw_region,
                               "<br>Sales:", round(total_sales/1e6, 1), "M",
                               "<br>Avg Price: $", format(avg_price, big.mark = ","))),
               color = "white", size = 0.1) +
  scale_fill_gradient(name = "Sales (M)",
                      low = "#E3F2FD",
                      high = "#0D47A1",
                      na.value = "lightgray") +
  labs(title = "BMW Sales Distribution by Region (2024)") +
  theme_void() +
  theme(legend.position = "right")

ggplotly(p_map, tooltip = "text")
```

Geographic distribution shows balanced global presence. All six regions contribute 16-17% of total volume each, with no single market dominating.

---

## 5. Price Analysis

```{r price-by-region}
p_price <- bmw_clean %>%
  ggplot(aes(x = region, y = price_usd, fill = region)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Price Distribution by Region",
       x = NULL,
       y = "Price (USD)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p_price)
```

Price distributions are nearly identical across regions, all centered around $75,000 with similar spread ($30,000-$120,000). This uniform pricing strategy suggests BMW maintains consistent positioning globally rather than adjusting for local purchasing power.

```{r price-sales-correlation}
cat("Correlation between price and sales volume:",
    round(cor(bmw_clean$price_usd, bmw_clean$sales_volume), 4), "\n")

p_scatter <- bmw_clean %>%
  sample_n(1000) %>%  # Sample for visualization
  ggplot(aes(x = price_usd, y = sales_volume)) +
  geom_point(alpha = 0.3, color = "#1C69D4") +
  geom_smooth(method = "lm", se = TRUE, color = "#0F4C81") +
  labs(title = "Price vs Sales Volume (Random Sample of 1,000 Configs)",
       x = "Price (USD)",
       y = "Sales Volume") +
  theme_minimal(base_size = 12)

ggplotly(p_scatter)
```

Price shows virtually no correlation with sales volume (r ≈ 0.00). This indicates BMW's luxury positioning allows for pricing independence - sales volumes are driven by factors other than price competitiveness.

---

## 6. Fuel Type Evolution

```{r fuel-trends}
fuel_yearly <- bmw_clean %>%
  group_by(year, fuel_type) %>%
  summarise(total_sales = sum(sales_volume), .groups = "drop")

p_fuel <- ggplot(fuel_yearly, aes(x = year, y = total_sales/1e6, fill = fuel_type)) +
  geom_area(alpha = 0.7) +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Sales Volume by Fuel Type (2010-2024)",
       x = "Year",
       y = "Sales (Millions)",
       fill = "Fuel Type") +
  theme_minimal(base_size = 12)

ggplotly(p_fuel)
```

```{r fuel-summary}
fuel_summary <- bmw_clean %>%
  group_by(fuel_type) %>%
  summarise(
    total_volume = sum(sales_volume),
    num_configs = n(),
    avg_sales = mean(sales_volume),
    pct_of_total = sum(sales_volume) / sum(bmw_clean$sales_volume) * 100
  ) %>%
  arrange(desc(total_volume))

knitr::kable(fuel_summary,
             col.names = c("Fuel Type", "Total Volume", "Num Configs", "Avg Sales", "% of Total"),
             digits = 1,
             caption = "Sales by Fuel Type")
```

Fuel type distribution is balanced: Hybrid (25.5%), Diesel (24.6%), Petrol (25.0%), Electric (25.0%). All four categories maintain similar market share throughout the period, suggesting BMW offers equal emphasis across all powertrain technologies.

---

## 7. Sales Classification Analysis

```{r sales-classification}
classification_dist <- bmw_clean %>%
  count(sales_classification) %>%
  mutate(pct = n / sum(n) * 100)

knitr::kable(classification_dist,
             col.names = c("Classification", "Count", "Percentage"),
             digits = 1,
             caption = "Distribution of Sales Classifications")
```

Sales classifications are based on volume thresholds: Low (< 7,000 units) represents 69.5% of configurations, while High (≥ 7,000 units) accounts for 30.5%. This 70/30 split suggests that while most configurations sell moderately, nearly one-third achieve high-volume sales.

```{r high-vs-low}
classification_comparison <- bmw_clean %>%
  group_by(sales_classification) %>%
  summarise(
    avg_price = mean(price_usd),
    avg_sales = mean(sales_volume),
    median_sales = median(sales_volume),
    count = n()
  )

knitr::kable(classification_comparison,
             col.names = c("Classification", "Avg Price", "Avg Sales", "Median Sales", "Count"),
             digits = 0,
             caption = "High vs Low Sales Configuration Characteristics")
```

Interestingly, average price is nearly identical between High and Low classifications ($75,034 vs $75,035), indicating price is not a determinant of sales success. The difference lies purely in volume: High configs average 7,780 units vs 3,791 for Low configs.

---

## 8. Configuration Diversity

```{r transmission-color}
transmission_dist <- bmw_clean %>%
  group_by(transmission) %>%
  summarise(
    total_volume = sum(sales_volume),
    num_configs = n(),
    avg_sales = mean(sales_volume)
  )

color_dist <- bmw_clean %>%
  group_by(color) %>%
  summarise(
    total_volume = sum(sales_volume),
    num_configs = n(),
    avg_sales = mean(sales_volume)
  ) %>%
  arrange(desc(avg_sales))

knitr::kable(transmission_dist,
             col.names = c("Transmission", "Total Volume", "Num Configs", "Avg Sales"),
             digits = 0,
             caption = "Sales by Transmission Type")

knitr::kable(color_dist,
             col.names = c("Color", "Total Volume", "Num Configs", "Avg Sales"),
             digits = 0,
             caption = "Sales by Color")
```

Transmission types show balanced distribution: Manual (50.3%) vs Automatic (49.7%) in terms of configurations, with similar average sales per config (5,063 vs 5,072).

Color preferences show minimal variation: Silver leads slightly with 5,111 avg sales, while Grey trails at 5,031 - a difference of only 80 units (1.6%). This suggests customer color preferences are diverse and no single color dominates.

---

## 9. Correlation Analysis

```{r correlation-matrix}
numeric_vars <- bmw_clean %>%
  select(year, engine_size_l, mileage_km, price_usd, sales_volume) %>%
  cor()

knitr::kable(numeric_vars, digits = 3, caption = "Correlation Matrix - Numeric Variables")
```

```{r correlation-viz}
library(reshape2)
cor_melted <- melt(numeric_vars)

p_cor <- ggplot(cor_melted, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(value, 2)), color = "white", size = 4) +
  scale_fill_gradient2(low = "#0F4C81", mid = "white", high = "#1C69D4",
                       midpoint = 0, limit = c(-1, 1)) +
  labs(title = "Correlation Heatmap",
       x = NULL, y = NULL, fill = "Correlation") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p_cor)
```

The correlation matrix reveals weak relationships between all variables. Key findings:

- Price vs Sales Volume: r = 0.000 (no relationship)
- Price vs Engine Size: r = 0.000 (no relationship)
- Year vs Sales Volume: r = 0.003 (virtually no trend)
- Mileage vs Price: r = -0.004 (negligible negative)

This pattern indicates BMW's sales performance is not driven by traditional price-volume trade-offs or product specifications. Instead, brand strength and market positioning appear to be the primary drivers.

---

## 10. Key Findings

**Market Maturity & Stability:**
- Sales volumes remain stable at 16-18M units annually from 2010-2024
- All regions show similar stability with minimal year-over-year volatility
- 2020 showed only modest decline (-5%), demonstrating market resilience

**Global Equilibrium:**
- Balanced distribution across 6 regions (each 16-17% of total)
- Uniform pricing strategy ($75K average globally)
- All 11 models perform similarly (5,009-5,122 avg sales per config)

**Product Diversity:**
- 50,000 unique configurations demonstrate extensive customization
- Balanced fuel type portfolio (each ~25% market share)
- Equal split between transmission types and diverse color options

**Price Independence:**
- Near-zero correlation between price and sales volume
- High and Low sales configs have identical average prices
- Suggests brand equity supports premium pricing regardless of volume

**Configuration Success:**
- 30% of configurations achieve "High" sales (≥7,000 units)
- Success is not predicted by price, model, or region
- Indicates strong demand across the entire product portfolio

This analysis reveals BMW operates in a mature luxury market characterized by stability, global balance, and pricing power. The weak correlations between product attributes and sales volumes suggest brand strength rather than product competition drives performance.

---

<style>
#code-toggle-btn {
    position: fixed;
    top: 90px;
    right: 20px;
    z-index: 1000;
    background: linear-gradient(135deg, #1C69D4, #0F4C81);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(28, 105, 212, 0.3);
    transition: all 0.3s;
}

#code-toggle-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(28, 105, 212, 0.4);
}

pre.r {
    display: none;
}

pre.r.show-code {
    display: block;
}
</style>

<button id="code-toggle-btn" onclick="toggleAllCode()">Show All Code</button>

<script>
let codeVisible = false;
function toggleAllCode() {
    const codeBlocks = document.querySelectorAll('pre.r');
    const button = document.getElementById('code-toggle-btn');
    codeVisible = !codeVisible;
    codeBlocks.forEach(block => {
        if (codeVisible) {
            block.classList.add('show-code');
        } else {
            block.classList.remove('show-code');
        }
    });
    button.textContent = codeVisible ? 'Hide All Code' : 'Show All Code';
}
</script>
